{"id":29419,"name":"testing-pipedriveInitialize","userId":27893,"accountId":24428,"createdDate":"2019-09-05T07:09:09Z","steps":[{"id":216331,"onSuccess":["updateElementInstanceParams"],"onFailure":["sendErrorParams_AuthFailed"],"name":"AccountValidationCheck","type":"filter","properties":{"body":"let accessToken = steps.ConfigParams.params.input.accessToken;\n\ndone(accessToken !== undefined);\n"}},{"id":216332,"onSuccess":[],"onFailure":[],"name":"AuthenticationError","type":"script","properties":{"body":"let err = {\n  \"status\":\"error\",\n};\nerr[steps.thirdPartyInstance.thirdPartyElementBody.configuration.account] = 'Authentication Failed';\n\ndone({\n  statusCode: 500,\n  result: err\n});"}},{"id":219655,"onSuccess":["chargebeeInstanceFound"],"onFailure":["createChargebeeInstanceParams"],"name":"cbInstanceFound","type":"filter","properties":{"body":"if(steps.getChargebeeInstance.response.code === 200){\n  done(true);\n}\n\ndone(false);"}},{"id":216333,"onSuccess":["getThirdPartyInstance"],"onFailure":[],"name":"chargebeeInstanceCreated","type":"script","properties":{"body":"done({\"id\":steps.createChargebeeInstance.response.body.id});"}},{"id":216334,"onSuccess":["getThirdPartyInstance"],"onFailure":[],"name":"chargebeeInstanceFound","type":"script","properties":{"body":"done({\"id\":steps.getChargebeeInstance.response.body[0].id});"}},{"id":216335,"onSuccess":["isInstanceExist"],"onFailure":[],"name":"checkInstanceExist","type":"script","properties":{"body":"let instances=steps.getInstances.response.body;\nlet siteName=steps.ConfigParams.params.input.siteName;\nlet bodyParam=steps.formulaInformation;\n\nlet flag = false;\nlet instanceInfo = '';\nlet formulaName;\n\nlet formulaNames = [\"formula_SyncRulesContactsConfig\",\n  \"formula_ValidateResult\"\n  ];\n  \n// let formulaNames = [\"formula_SyncRulesContactsConfig\",\n//   \"formula_ValidateResult\",\n//   \"formula_SyncCustomers\",\n//   \"formula_SyncSubscription\",\n//   \"formula_SyncInvoice\"\n//   ];\n  \nlet existingInstanceIds = {};\n\nif(steps.setInstanceInfo.instanceList.length !== 0){\n  existingInstanceIds = steps.setInstanceInfo.instanceList;\n}\n\nlet instanceNames=[bodyParam.formula_SyncRulesContactsConfig.name,\n  bodyParam.formula_ValidateResult.name\n];\n\nlet param=[bodyParam.formula_SyncRulesContactsConfig,\n  bodyParam.formula_ValidateResult\n];\n\n// let instanceNames=[bodyParam.formula_SyncRulesContactsConfig.name,\n//   bodyParam.formula_ValidateResult.name,\n//   bodyParam.formula_SyncCustomers.name,\n//   bodyParam.formula_SyncSubscription.name,\n//   bodyParam.formula_SyncInvoice.name,\n// ];\n\n// let param=[bodyParam.formula_SyncRulesContactsConfig,\n//   bodyParam.formula_ValidateResult,\n//   bodyParam.formula_SyncCustomers,\n//   bodyParam.formula_SyncSubscription,\n//   bodyParam.formula_SyncInvoice\n// ];\n\n\nfor(var i=0;i<instances.length;i++){\n  if(instances[i].name === instanceNames[steps.loopOverFormulaList.index]){\n    flag = true;\n    instanceInfo =  instances[i];\n    formulaName = formulaNames[steps.loopOverFormulaList.index];\n    existingInstanceIds[formulaName] = instanceInfo[\"id\"];\n    break;\n  }\n}\n\nif(flag === false){\n  done({\n    flag: false,\n    formulaName : formulaNames[steps.loopOverFormulaList.index],\n    instanceInfo: param[steps.loopOverFormulaList.index],\n    existingInstanceIds: existingInstanceIds\n  });\n}\n\nif(flag === true){\n  done({\n    flag: true,\n    formulaName : formulaNames[steps.loopOverFormulaList.index],\n    instanceInfo: instanceInfo,\n    existingInstanceIds: existingInstanceIds\n  });\n}\n\n\n\n\n"}},{"id":216336,"onSuccess":["thirdPartyInstance"],"onFailure":[],"name":"ConfigParams","type":"script","properties":{"body":"let initParams = steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.initParams;\n\nlet chargebeeElement = initParams.chargebeeElement;\nlet thirdPartyElement = initParams.thirdPartyElement;\n\nlet formula_SyncRulesContactsSetup = initParams.formula_SyncRulesContactsSetup;\nlet formula_SyncRulesContactsConfig = initParams.formula_SyncRulesContactsConfig;\nlet formula_SyncRulesDealsSetup = initParams.formula_SyncRulesDealsSetup;\nlet formula_SyncRulesDealsConfig = initParams.formula_SyncRulesDealsConfig;\nlet formula_SyncFieldsSetup = initParams.formula_SyncFieldsSetup;\nlet formula_SyncFieldsConfig = initParams.formula_SyncFieldsConfig;\nlet formula_ValidateSetup = initParams.formula_ValidateSetup;\nlet formula_ValidateIgnore = initParams.formula_ValidateIgnore;\nlet formula_ValidateResult = initParams.formula_ValidateResult;\nlet formula_InitialSyncRun = initParams.formula_InitialSyncRun;\nlet formula_FullSyncRun = initParams.formula_FullSyncRun;\nlet formula_SyncDispatcher = initParams.formula_SyncDispatcher;\nlet formula_SyncCustomers = initParams.formula_SyncCustomers;\nlet formula_SyncSubscription = initParams.formula_SyncSubscription;\nlet formula_SyncInvoice = initParams.formula_SyncInvoice;\nlet formula_GetPipelineStages = initParams.formula_GetPipelineStages;\nlet formula_ManageSyncRules_Save = initParams.formula_ManageSyncRules_Save;\nlet formula_GetRefreshToken = initParams.formula_GetRefreshToken;\n\nlet params = {};\nparams.input = steps.InputParams.params.input;\n\nparams.input.chargebeeElement = chargebeeElement;\nparams.input.thirdPartyElement = thirdPartyElement;\n\nparams.input.formulas = {\n  formula_SyncRulesContactsSetup: formula_SyncRulesContactsSetup,\n  formula_SyncRulesContactsConfig: formula_SyncRulesContactsConfig,\n  formula_SyncRulesDealsSetup: formula_SyncRulesDealsSetup,\n  formula_SyncRulesDealsConfig: formula_SyncRulesDealsConfig,\n  formula_SyncFieldsSetup: formula_SyncFieldsSetup,\n  formula_SyncFieldsConfig: formula_SyncFieldsConfig,\n  formula_ValidateSetup: formula_ValidateSetup,\n  formula_ValidateIgnore: formula_ValidateIgnore,\n  formula_ValidateResult: formula_ValidateResult,\n  formula_InitialSyncRun: formula_InitialSyncRun,\n  formula_FullSyncRun: formula_FullSyncRun,\n  formula_SyncDispatcher: formula_SyncDispatcher,\n  formula_SyncCustomers: formula_SyncCustomers,\n  formula_SyncSubscription: formula_SyncSubscription,\n  formula_SyncInvoice: formula_SyncInvoice,\n  formula_GetPipelineStages: formula_GetPipelineStages,\n  formula_ManageSyncRules_Save: formula_ManageSyncRules_Save,\n  formula_GetRefreshToken: formula_GetRefreshToken\n};\n\n\nlet mandatoryInstances = {\n  instance_SyncRulesContactsSetup: initParams.instance_SyncRulesContactsSetup,\n  instance_SyncRulesDealsSetup: initParams.instance_SyncRulesDealsSetup,\n  instance_SyncFieldsSetup: initParams.instance_SyncFieldsSetup,\n  instance_ValidateSetup: initParams.instance_ValidateSetup,\n  instance_InitialSyncRun: initParams.instance_InitialSyncRun,\n  instance_FullSyncRun: initParams.instance_FullSyncRun,\n  instance_GetPipelineStages: initParams.instance_GetPipelineStages\n}\n\ndone({\n  params: params,\n  mandatoryInstances: mandatoryInstances\n});"}},{"id":216337,"onSuccess":["chargebeeInstanceCreated"],"onFailure":["sendErrorMail"],"name":"createChargebeeInstance","type":"request","properties":{"api":"${steps.createChargebeeInstanceParams.createChargebeeInstanceConfig.url}","method":"POST","query":"","body":"${steps.createChargebeeInstanceParams.createChargebeeInstanceConfig.body}"}},{"id":216338,"onSuccess":["createChargebeeInstance"],"onFailure":[],"name":"createChargebeeInstanceParams","type":"script","properties":{"body":"let chargebeeElementId = steps.queryParams.params.chargebee.elementId || null;\n\nlet createChargebeeInstanceConfig = {\n  url: \"/elements/\"+chargebeeElementId+\"/instances\",\n  body: steps.queryParams.params.chargebee.body\n};\n\n\ndone({\n  createChargebeeInstanceConfig: createChargebeeInstanceConfig\n});"}},{"id":216339,"onSuccess":["newInstanceCreatedInfo"],"onFailure":[],"name":"createFormulaInstance","type":"request","properties":{"retry":"true","api":"${steps.createFormulaInstanceParams.createInstanceConfig.url}","method":"POST","retryAttempts":"5","body":"${steps.createFormulaInstanceParams.createInstanceConfig.body}","retryDelay":"200"}},{"id":216340,"onSuccess":["createFormulaInstance"],"onFailure":[],"name":"createFormulaInstanceParams","type":"script","properties":{"body":"let formulaId = steps.loopOverFormulaList.entry || null;\n\n\nlet createInstanceConfig = {\n  url: \"/formulas/\"+formulaId+\"/instances\",\n  body: steps.checkInstanceExist.instanceInfo\n};\n\n\ndone({\n  createInstanceConfig: createInstanceConfig\n});\n\n\n"}},{"id":216341,"onSuccess":["thirdPartyInstanceCreated"],"onFailure":["sendErrorParams_AuthFailed"],"name":"createThirdPartyInstance","type":"request","properties":{"api":"${steps.createTpInstanceParams.createTpInstanceConfig.url}","method":"POST","body":"${steps.createTpInstanceParams.createTpInstanceConfig.body}","headers":""}},{"id":216342,"onSuccess":["createThirdPartyInstance"],"onFailure":[],"name":"createTpInstanceParams","type":"script","properties":{"body":"let tpElementId = steps.queryParams.params.thirdParty.elementId || null;\n\nlet createTpInstanceConfig = {\n  url: \"/elements/\"+tpElementId+\"/instances\",\n  body: steps.queryParams.params.thirdParty.body\n};\n\n\ndone({\n  createTpInstanceConfig: createTpInstanceConfig\n});\n\n"}},{"id":216343,"onSuccess":["loopOverFormulaList"],"onFailure":[],"name":"formulaIdList","type":"script","properties":{"body":"// let formula_SyncRulesContactsSetup = steps.ConfigParams.params.input.formulas.formula_SyncRulesContactsSetup;\nlet formula_SyncRulesContactsConfig = steps.ConfigParams.params.input.formulas.formula_SyncRulesContactsConfig;\n\nlet formula_ValidateResult = steps.ConfigParams.params.input.formulas.formula_ValidateResult;\n\n// let formula_SyncCustomers = steps.ConfigParams.params.input.formulas.formula_SyncCustomers;\n// let formula_SyncSubscription = steps.ConfigParams.params.input.formulas.formula_SyncSubscription;\n// let formula_SyncInvoice = steps.ConfigParams.params.input.formulas.formula_SyncInvoice;\n// let formula_GetPipelineStages = steps.ConfigParams.params.input.formulas.formula_GetPipelineStages;\n\nlet formulaList=[formula_SyncRulesContactsConfig,formula_ValidateResult];\n\ndone({formulaList:formulaList});\n\n"}},{"id":216344,"onSuccess":["formulaIdList"],"onFailure":[],"name":"formulaInformation","type":"script","properties":{"body":"let chargebeeInstanceId = 0;\nlet thirdPartyInstanceId = 0;\n\nlet siteName = steps.ConfigParams.params.input.siteName;\n\nif(steps.chargebeeInstanceFound !== undefined) {\n  chargebeeInstanceId = steps.chargebeeInstanceFound.id;\n}\n\nif(steps.chargebeeInstanceCreated !== undefined) {\n  chargebeeInstanceId = steps.chargebeeInstanceCreated.id;\n}\n\nif(steps.thirdPartyInstanceFound !== undefined) {\n  thirdPartyInstanceId = steps.thirdPartyInstanceFound.id;\n}\n\nif(steps.thirdPartyInstanceCreated !== undefined) {\n  thirdPartyInstanceId = steps.thirdPartyInstanceCreated.id;\n}\n\ndone({\n  chargebee:chargebeeInstanceId,\n  thirdParty:thirdPartyInstanceId,\n  // formula_SyncRulesContactsSetup: {\n  //   active: true,\n  //   configuration: {},\n  //   name: siteName + \"-SyncRulesContactsSetup\"\n  // },\n  formula_SyncRulesContactsConfig:{\n    active: true,\n    configuration: {},\n    name: siteName + \"-SyncRulesContactsConfig\"\n  },\n  formula_ValidateResult:{\n    active: true,\n    configuration: {\n      chargebee: chargebeeInstanceId\n    },\n    name: siteName + \"-ValidateResult\"\n  },\n  // formula_SyncCustomers:{\n  //   active: true,\n  //   configuration: {\n  //     chargebee: chargebeeInstanceId,\n  //     pipedrive: thirdPartyInstanceId\n  //   },\n  //   name: siteName + \"-SyncCustomers\"\n  // },\n  // formula_SyncSubscription:{\n  //   active: true,\n  //   configuration: {\n  //     chargebee: chargebeeInstanceId,\n  //     pipedrive: thirdPartyInstanceId\n  //   },\n  //   name: siteName + \"-SyncSubscription\"\n  // },\n  // formula_SyncInvoice:{\n  //   active: true,\n  //   configuration: {\n  //     chargebee: chargebeeInstanceId,\n  //     pipedrive: thirdPartyInstanceId\n  //   },\n  //   name: siteName + \"-SyncInvoice\"\n  // },\n  // formula_GetPipelineStages:{\n  //   active: true,\n  //   configuration: {},\n  //   name: siteName + \"-GetPipelineStages\"\n  // }\n});\n\n\n"}},{"id":216345,"onSuccess":["loopOverFormulaList"],"onFailure":[],"name":"formulaInstancesInfo","type":"script","properties":{"body":"let formulaName = steps.checkInstanceExist.formulaName;\nlet formulaInstances = steps.checkInstanceExist.existingInstanceIds;\n\nformulaInstances.formulaName = steps.checkInstanceExist.instanceInfo.id;\n\ndone({\n  formulaInstances: formulaInstances\n});"}},{"id":216346,"onSuccess":["cbInstanceFound"],"onFailure":["cbInstanceFound"],"name":"getChargebeeInstance","type":"request","properties":{"retry":"false","method":"GET","api":"/instances","query":"${steps.queryParams.params.chargebee.searchParam}","retryAttempts":"1","acceptableStatusCodes":"200,404","retryDelay":"0"}},{"id":216347,"onSuccess":["checkInstanceExist"],"onFailure":[],"name":"getInstances","type":"request","properties":{"api":"/formulas/${steps.loopOverFormulaList.entry}/instances","method":"GET"}},{"id":216348,"onSuccess":["instanceFound"],"onFailure":["instanceFound"],"name":"getThirdPartyInstance","type":"request","properties":{"method":"GET","api":"/instances","query":"${steps.queryParams.params.thirdParty.searchParam}","acceptableStatusCodes":"200,404"}},{"id":216349,"onSuccess":["AccountValidationCheck"],"onFailure":[],"name":"getThirdPartyInstanceDetails","type":"request","properties":{"api":"/instances/${steps.thirdPartyInstanceFound.id}","method":"GET"}},{"id":216350,"onSuccess":["validateParams"],"onFailure":[],"name":"getTpConfig","type":"httpRequest","properties":{"retry":"true","url":"${steps.InputParams.getTpConfigParams.url}","method":"GET","query":"${steps.InputParams.getTpConfigParams.query}","retryAttempts":"5","headers":"${steps.InputParams.getTpConfigParams.auth}","retryDelay":"200"}},{"id":216351,"onSuccess":["getTpConfig"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let cb_api_info = JSON.parse(trigger.args.request.query['cb_api_info']) || null;\n\nlet apiKey = cb_api_info['cb-api-key'] || null;\nlet siteName = cb_api_info['cb-site-name'] || null;\nlet integrationName = cb_api_info['integrationName'] || null;\nlet siteDomain = cb_api_info['siteDomain'] || null;\nlet password = \"\";\n\n\nlet accessToken = trigger.args.request.query['access_token'];\nlet tokenType = trigger.args.request.query['token_type'];\nlet expiresIn = trigger.args.request.query['expires_in'];\nlet refreshToken = trigger.args.request.query['refresh_token'];\nlet redirectUri = trigger.args.request.query['redirect_uri'];\nlet scope = trigger.args.request.query['scope'];\n\n\nlet errorEmailEndpoint =  'https://' + siteName + '.' + siteDomain + '/adhoc_checkout_email/api/send';\n// let errorEmailAddress = \"integrations-growth-internal@chargebee.com\";\nlet errorEmailAddress = \"ajaitester@gmail.com\";\n\nlet params = {\n  input: {\n    apiKey: apiKey,\n    accessToken: accessToken,\n    tokenType: tokenType,\n    expiresIn: expiresIn,\n    refreshToken: refreshToken,\n    redirectUri: redirectUri,\n    scope: scope,\n    siteName: siteName,\n    siteDomain:siteDomain,\n    integrationName: integrationName,\n    errorEmailEndpoint: errorEmailEndpoint,\n    errorEmailAddress: errorEmailAddress,\n  }\n};\n\nlet sendErrorMailParams = {\n  url: errorEmailEndpoint,\n  headers:{\n    Authorization: \"Basic \" + CE.b64(apiKey + \":\" + \"\")\n  },\n  query :{\n    content : \"Integration Error, Formula-Instance-ID : \" + trigger.args.request.headers['elements-formula-instance-id'],\n    subject : \"Fatal Error Occurred during \" + integrationName + \" Sync\",\n    to_address : errorEmailAddress,\n    api_key : apiKey\n  }\n};\n\nlet getTpConfigParams = {\n    url: \"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_configurations\",\n    auth:{\n      Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password)\n    },\n    query:{\n      integration_name: integrationName\n    }\n};\n\n\nlet tpConfigUpdateParams = {\n  url: \"https://\"+siteName+\".integrations.\"+siteDomain+\"/integrations/update_tp_integ_conf\",\n  headers: {\n    \"Content-Type\": \"application/json\",\n    \"cache-control\": \"no-cache\"\n  },\n  body:  {\n     site_name: siteName,\n     api_key: apiKey,\n     integration_name: integrationName\n  }\n}\n\ndone({\n  params: params,\n  sendErrorMailParams: sendErrorMailParams,\n  tpConfigUpdateParams: tpConfigUpdateParams,\n  getTpConfigParams: getTpConfigParams\n});"}},{"id":216352,"onSuccess":["thirdPartyInstanceFound"],"onFailure":["isValidAccessCode"],"name":"instanceFound","type":"filter","properties":{"body":"if(steps.getThirdPartyInstance.response.code === 200){\n  done(true);\n}\n\ndone(false);"}},{"id":216353,"onSuccess":["updateTpConfigParams"],"onFailure":[],"name":"instanceIdList","type":"script","properties":{"body":"let instanceIds = [];\n\nif(steps.checkInstanceExist !== undefined){\n  instanceIds = steps.checkInstanceExist.existingInstanceIds;\n}\n\nif(steps.newInstanceCreatedInfo !== undefined){\n  instanceIds = steps.newInstanceCreatedInfo.instanceList;\n}\n\ndone({\n  instanceIds: instanceIds\n});\n\n"}},{"id":216354,"onSuccess":["loopOverFormulaList"],"onFailure":["createFormulaInstanceParams"],"name":"isInstanceExist","type":"filter","properties":{"body":"done(steps.checkInstanceExist.flag);"}},{"id":216355,"onSuccess":["createTpInstanceParams"],"onFailure":["sendErrorParams_AuthFailed"],"name":"isValidAccessCode","type":"httpRequest","properties":{"retry":"false","url":"${steps.thirdPartyInstance.checkValidAccessCode.url}","method":"GET","retryAttempts":"1","acceptableStatusCodes":"200,404","headers":"${steps.thirdPartyInstance.checkValidAccessCode.headers}","retryDelay":"0"}},{"id":216356,"onSuccess":["setInstanceInfo"],"onFailure":["instanceIdList"],"name":"loopOverFormulaList","type":"loop","properties":{"list":"${steps.formulaIdList.formulaList}"}},{"id":216357,"onSuccess":["loopOverFormulaList"],"onFailure":[],"name":"newInstanceCreatedInfo","type":"script","properties":{"body":"let formulaName = steps.checkInstanceExist.formulaName;\nlet instanceList = steps.checkInstanceExist.existingInstanceIds;\n\ninstanceList[formulaName] = steps.createFormulaInstance.response.body.id;\n\ndone({\n  instanceList: instanceList\n});\n\n"}},{"id":216358,"onSuccess":["getChargebeeInstance"],"onFailure":[],"name":"queryParams","type":"script","properties":{"body":"let params = steps.ConfigParams.params.input;\nlet thirdParty = steps.thirdPartyInstance.thirdPartyElementBody;\nlet instanceName = params.siteName + \".\" + params.siteDomain+\"-chargebee\";\n\nparams.chargebee =  {\n  elementId: params.chargebeeElement,\n  searchParam: {\n    searchText: instanceName,\n    'tags[]': instanceName,\n    hydrate: false,\n    pageSize: 1\n  },\n  body: {\n    name: instanceName,\n    configuration: {\n      username: params.apiKey,\n      site: params.siteName + \".\" + params.siteDomain,\n      password: \"\"\n    },\n    tags: [instanceName,params.siteName]\n  }\n};\n  \nparams.thirdParty  =  {\n  elementId: params.thirdPartyElement,\n  elementKey:params.integrationName,\n  searchParam: {\n    searchText: thirdParty.name,\n    'tags[]': thirdParty.name,\n    hydrate: false,\n    pageSize: 1\n  },\n  body: thirdParty\n};\n  \ndone({\n  params: params\n});\n\n"}},{"id":216359,"onSuccess":["AuthenticationError"],"onFailure":[],"name":"sendError_AuthFailed","type":"httpRequest","properties":{"retry":"true","url":"${steps.sendErrorParams_AuthFailed.payload.url}","method":"POST","query":"${steps.sendErrorParams_AuthFailed.payload.query}","retryAttempts":"5","headers":"${steps.sendErrorParams_AuthFailed.payload.headers}","retryDelay":"200"}},{"id":216360,"onSuccess":[],"onFailure":[],"name":"sendErrorCard","type":"script","properties":{"body":"let card = {\n    \"cards\": [{\n        \"id\": \"check2\",\n        \"card\": {\n            \"type\": \"ACTION\",\n            \"heading\": \"Integration Error:  Initialization Failed\",\n            \"listContent\": [\n                \"Integration Error:  Initialization Failed\"\n            ],\n            \"icon\": \"WARNING\"\n          \n        }\n    }]\n}\n\ndone({\n  statusCode: 500,\n  result: card\n})"}},{"id":216361,"onSuccess":["sendErrorCard"],"onFailure":["sendErrorCard"],"name":"sendErrorMail","type":"httpRequest","properties":{"retry":"true","url":"${steps.InputParams.sendErrorMailParams.url}","method":"POST","query":"${steps.InputParams.sendErrorMailParams.query}","retryAttempts":"5","headers":"${steps.InputParams.sendErrorMailParams.headers}","retryDelay":"200"}},{"id":216362,"onSuccess":["sendError_AuthFailed"],"onFailure":[],"name":"sendErrorParams_AuthFailed","type":"script","properties":{"body":"let errorPayload = steps.InputParams.sendErrorMailParams;\n\nerrorPayload.query.content = \"Pipedrive Authentication Failed : Failed to Authenticate \" + steps.thirdPartyInstance.thirdPartyElementBody.configuration.account;\n\nerrorPayload.query.subject = \"Authentication Error\";\n\ndone({\n  payload : errorPayload\n});\n\n"}},{"id":216363,"onSuccess":["getInstances"],"onFailure":[],"name":"setInstanceInfo","type":"script","properties":{"body":"let instanceList = {};\n\n\nif((steps.isInstanceExist !== undefined) && (steps.isInstanceExist.continue === true)){\n  instanceList = steps.checkInstanceExist.existingInstanceIds;\n}\n\nif((steps.isInstanceExist !== undefined) && (steps.isInstanceExist.continue === false)){\n  instanceList = steps.newInstanceCreatedInfo.instanceList;\n}\n\ndone({\n  instanceList: instanceList\n});\n\n"}},{"id":216364,"onSuccess":[],"onFailure":[],"name":"Success","type":"script","properties":{"body":"done({\n  statusCode: 200,\n  result: {\n    \"chargebeeInstanceId\": steps.formulaInformation.chargebee,\n    \"thirdPartyInstanceId\": steps.formulaInformation.thirdParty,\n  }\n});"}},{"id":216365,"onSuccess":["queryParams"],"onFailure":[],"name":"thirdPartyInstance","type":"script","properties":{"body":"let thirdPartyElement = steps.ConfigParams.params.input.thirdPartyElement;\nlet siteName = steps.ConfigParams.params.input.siteName;\nlet accessToken = steps.ConfigParams.params.input.accessToken; \nlet tokenType = steps.ConfigParams.params.input.tokenType; \n\n\n\nlet thirPartyInstanceName = siteName + '-pipedrive';\n\n// let body = {\n//   name: thirPartyInstanceName,\n//   configuration: {\n//     \"authentication.type\": \"accessToken\",\n//     \"pipedrive.api.token\":apiToken\n//   },\n//   tags: [thirPartyInstanceName,siteName]\n// };\n\nlet body = {\n  name: thirPartyInstanceName,\n  configuration: {\n    \"filter.response.nulls\": \"true\",\n    \"access_token\": tokenType + \" \" + accessToken\n  },\n  tags: [thirPartyInstanceName,siteName]\n};\n\n\nlet checkValidAccessCode = {\n  url: \"https://api-proxy.pipedrive.com/pipelines\",\n  headers: {\n    \"Authorization\" : tokenType + \" \" + accessToken,\n    \"Accept\": \"application/json\"\n  }\n}\n\n\ndone({\n  thirdPartyElementBody: body,\n  checkValidAccessCode: checkValidAccessCode\n});\n\n"}},{"id":216366,"onSuccess":["formulaInformation"],"onFailure":[],"name":"thirdPartyInstanceCreated","type":"script","properties":{"body":"done({\"id\":steps.createThirdPartyInstance.response.body.id});"}},{"id":216367,"onSuccess":["getThirdPartyInstanceDetails"],"onFailure":[],"name":"thirdPartyInstanceFound","type":"script","properties":{"body":"done({\"id\":steps.getThirdPartyInstance.response.body[0].id});"}},{"id":216368,"onSuccess":["updateThirdPartyInstance"],"onFailure":[],"name":"updateElementInstanceParams","type":"script","properties":{"body":"let thirdPartyElementId = steps.thirdPartyInstanceFound.id || null;\nlet config = steps.getThirdPartyInstanceDetails.response.body;\n\nlet accessToken  = steps.ConfigParams.params.input.accessToken;\nlet tokenType = steps.ConfigParams.params.input.tokenType;\n\n// config.configuration['authentication.type'] = \"accessToken\";\n// config.configuration[\"pipedrive.api.token\"] = apiToken;\n\nconfig.configuration['access_token'] = tokenType + \" \" + accessToken;\n\nlet updateParams={\n  url: \"/instances/\"+thirdPartyElementId,\n  body: config\n};\n\ndone({\n  updateParams: updateParams\n});\n\n"}},{"id":216369,"onSuccess":["formulaInformation"],"onFailure":["sendErrorParams_AuthFailed"],"name":"updateThirdPartyInstance","type":"request","properties":{"api":"${steps.updateElementInstanceParams.updateParams.url}","method":"PUT","body":"${steps.updateElementInstanceParams.updateParams.body}"}},{"id":216370,"onSuccess":["Success"],"onFailure":["sendErrorMail"],"name":"updateTpConfig","type":"httpRequest","properties":{"retry":"true","url":"${steps.updateTpConfigParams.tpConfigUpdateParams.url}","method":"POST","retryAttempts":"5","body":"${steps.updateTpConfigParams.tpConfigUpdateParams.body}","headers":"${steps.updateTpConfigParams.tpConfigUpdateParams.headers}","retryDelay":"200"}},{"id":216371,"onSuccess":["updateTpConfig"],"onFailure":[],"name":"updateTpConfigParams","type":"script","properties":{"body":"let params = steps.ConfigParams.params.input;\n\nlet configJson = {\n  cloudElements: {\n    OAuth_Parameters : {\n      access_token : steps.ConfigParams.params.input.tokenType + \" \" + steps.ConfigParams.params.input.accessToken,\n      expiry_time : Math.round((new Date().getTime())/1000) + Number(steps.ConfigParams.params.input.expiresIn),\n      refresh_token : steps.ConfigParams.params.input.refreshToken,\n      token_type : steps.ConfigParams.params.input.tokenType,\n      scope : steps.ConfigParams.params.input.scope,\n      client_info : JSON.parse(steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.initParams.client_info) || null\n    },\n    chargebee: {\n      element: params.chargebeeElement,\n      instance: steps.formulaInformation.chargebee\n    },\n    thirdParty: {\n      element: params.thirdPartyElement,\n      instance: steps.formulaInformation.thirdParty\n    },\n    formulas:{\n      formula_SyncRulesContactsSetup:{\n        id: params.formulas.formula_SyncRulesContactsSetup,\n        instance: steps.ConfigParams.mandatoryInstances.instance_SyncRulesContactsSetup\n      },\n      formula_SyncRulesContactsConfig:{\n        id: params.formulas.formula_SyncRulesContactsConfig,\n        instance: steps.instanceIdList.instanceIds.formula_SyncRulesContactsConfig\n      },\n      formula_SyncRulesDealsSetup:{\n        id: params.formulas.formula_SyncRulesDealsSetup,\n        instance: steps.ConfigParams.mandatoryInstances.instance_SyncRulesDealsSetup\n      },\n      formula_SyncRulesDealsConfig:{\n        id: params.formulas.formula_SyncRulesDealsConfig,\n        instance: steps.instanceIdList.instanceIds.formula_SyncRulesDealsConfig\n      },\n      formula_SyncFieldsSetup:{\n        id: params.formulas.formula_SyncFieldsSetup,\n        instance: steps.ConfigParams.mandatoryInstances.instance_SyncFieldsSetup\n      },\n      formula_SyncFieldsConfig:{\n        id: params.formulas.formula_SyncFieldsConfig,\n        instance: steps.instanceIdList.instanceIds.formula_SyncFieldsConfig\n      },\n      formula_ValidateSetup:{\n        id: params.formulas.formula_ValidateSetup,\n        instance: steps.ConfigParams.mandatoryInstances.instance_ValidateSetup\n      },\n      formula_ValidateIgnore:{\n        id: params.formulas.formula_ValidateIgnore,\n        instance: steps.instanceIdList.instanceIds.formula_ValidateIgnore\n      },\n      formula_ValidateResult:{\n        id: params.formulas.formula_ValidateResult,\n        instance: steps.instanceIdList.instanceIds.formula_ValidateResult\n      },\n      formula_InitialSyncRun:{\n        id: params.formulas.formula_InitialSyncRun,\n        instance: steps.ConfigParams.mandatoryInstances.instance_InitialSyncRun,\n        syncSetupStatus: \"NOT_CONFIGURED\"\n      },\n      formula_FullSyncRun:{\n        id: params.formulas.formula_FullSyncRun,\n        instance: steps.ConfigParams.mandatoryInstances.instance_FullSyncRun\n      },\n      formula_SyncDispatcher:{\n        id: params.formulas.formula_SyncDispatcher,\n        instance: steps.instanceIdList.instanceIds.formula_SyncDispatcher\n      },\n      formula_SyncCustomers:{\n        id: params.formulas.formula_SyncCustomers,\n        instance: steps.instanceIdList.instanceIds.formula_SyncCustomers\n      },\n      formula_SyncSubscription:{\n        id: params.formulas.formula_SyncSubscription,\n        instance: steps.instanceIdList.instanceIds.formula_SyncSubscription\n      },\n      formula_SyncInvoice:{\n        id: params.formulas.formula_SyncInvoice,\n        instance: steps.instanceIdList.instanceIds.formula_SyncInvoice\n      },\n      formula_GetPipelineStages:{\n        id: params.formulas.formula_GetPipelineStages,\n        instance: steps.ConfigParams.mandatoryInstances.instance_GetPipelineStages\n      },\n      formula_ManageSyncRules_Save:{\n        id: params.formulas.formula_ManageSyncRules_Save,\n        instance: steps.instanceIdList.instanceIds.formula_ManageSyncRules_Save\n      },\n      formula_GetRefreshToken:{\n        id: params.formulas.formula_GetRefreshToken,\n        instance: steps.instanceIdList.instanceIds.formula_GetRefreshToken\n      }\n    }\n  },\n  \"new_sub_step\": \"connect\"\n}\n\n\nlet tpConfigUpdateParams = steps.InputParams.tpConfigUpdateParams;\ntpConfigUpdateParams.body.config_json = configJson;\n\ndone({\n  tpConfigUpdateParams: tpConfigUpdateParams\n});\n\n"}},{"id":216372,"onSuccess":["ConfigParams"],"onFailure":["sendErrorMail"],"name":"validateParams","type":"filter","properties":{"body":"if(steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.initParams !== undefined){\n  let initParams = steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.initParams;\n  \n  console.log(\"R\");\n  \n  if(trigger.args.request.query['access_token'] === undefined){\n     console.log(\"RR\");\n    done(false);\n  }\n  \n  if(trigger.args.request.query['token_type'] === undefined){\n     console.log(\"RFRR\");\n    done(false);\n  }\n  \n  if((initParams.formula_FullSyncRun === undefined) || (initParams.formula_InitialSyncRun === undefined) || (initParams.formula_SyncCustomers === undefined) || (initParams.formula_SyncDispatcher === undefined) || (initParams.formula_SyncFieldsConfig === undefined) || (initParams.formula_SyncFieldsSetup === undefined) || (initParams.formula_SyncInvoice === undefined) || (initParams.formula_SyncRulesContactsConfig === undefined) || (initParams.formula_SyncRulesContactsSetup === undefined) || (initParams.formula_SyncRulesDealsConfig === undefined) || (initParams.formula_SyncRulesDealsSetup === undefined) || (initParams.formula_SyncSubscription === undefined) || (initParams.formula_ValidateIgnore === undefined) || (initParams.formula_ValidateResult === undefined) || (initParams.formula_ValidateSetup === undefined)){\n    \n    console.log(\"xyxy\");\n    done(false);\n    \n  }\n  \n  if((initParams.chargebeeElement === undefined) || (initParams.thirdPartyElement === undefined)){\n     console.log(\"RRRRRR\");\n    done(false);\n  }\n  \n  \n  done(true);\n  \n}\n\n console.log(\"GGGGGGG\");\ndone(false);\n\n"}}],"triggers":[{"id":26047,"onSuccess":["InputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"method":"GET","uri":"/pipedrive/init","engine":"v1","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"api":"GET /pipedrive/init","configuration":[]}