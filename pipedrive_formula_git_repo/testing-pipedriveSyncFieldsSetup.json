{"id":29407,"name":"testing-pipedriveSyncFieldsSetup","userId":27893,"accountId":24428,"createdDate":"2019-09-05T06:59:10Z","steps":[{"id":219847,"onSuccess":["InputParams"],"onFailure":[],"name":"EnvProps","type":"script","properties":{"body":"let cloudElementsUrl = \"https://staging.cloud-elements.com/elements/api-v2\";\n\ndone({\n  cloudElementsUrl: cloudElementsUrl\n});"}},{"id":215739,"onSuccess":["Success"],"onFailure":[],"name":"getCustomFieldsFromChargebee","type":"httpRequest","properties":{"method":"GET","query":"${steps.InputParams.getCustomFieldApi.query}","retryAttempts":"5","headers":"${steps.InputParams.getCustomFieldApi.headers}","retryDelay":"200","url":"${steps.InputParams.getCustomFieldApi.url}","retry":"true"}},{"id":215740,"onSuccess":["getCustomFieldsFromChargebee"],"onFailure":[],"name":"getTpConfig","type":"httpRequest","properties":{"method":"GET","query":"${steps.InputParams.getTpConfigParams.query}","retryAttempts":"5","headers":"${steps.InputParams.getTpConfigParams.auth}","retryDelay":"200","url":"${steps.InputParams.getTpConfigParams.url}","retry":"true"}},{"id":215741,"onSuccess":["getTpConfig"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let apiKey = trigger.args.request.query['cb-api-key'] || null;\nlet siteName = trigger.args.request.query['cb-site-name'] || null;\nlet siteDomain = trigger.args.request.query['cb-domain'] || null;\nlet integration_name = \"pipedrive\";\nlet password = \"\";\n\n\nlet params = {\n  input:{\n    apiKey: apiKey,\n    siteName: siteName,\n    siteDomain: siteDomain,\n    integration_name: integration_name,\n    password: password\n  }\n};\n\nlet getTpConfigParams = {\n  url: \"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_configurations\",\n  auth:{\n    Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password)\n  },\n  query:{\n    integration_name: integration_name\n  }\n};\n\nlet getCustomFieldApi = {\n  url: \"https://\"+siteName+\".integrations.\"+siteDomain+\"/integrations/api/get_custom_field_list\",\n  headers:{\n    Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password)\n  },\n  query:{\n    site_name: siteName,\n    api_key: apiKey\n  }\n}\n\ndone({\n  params: params,\n  getCustomFieldApi: getCustomFieldApi,\n  getTpConfigParams: getTpConfigParams\n});"}},{"id":215742,"onSuccess":[],"onFailure":[],"name":"Success","type":"script","properties":{"body":"let cloudElementsUrl = steps.EnvProps.cloudElementsUrl;\nlet syncFieldsConfigInstance = steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.formulas.formula_SyncFieldsConfig.instance;\nlet fields = steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.syncFields || {};\nconsole.log(fields);\nlet linkSubAttributesToPerson = steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.syncRulesContacts.linkSubAttributesToPerson;\nlet customFields = JSON.parse(steps.getCustomFieldsFromChargebee.response.body.response) || null;\nlet chargebeeCustomFields;\nlet customFields_customer;\nlet customFields_subscription;\nif (customFields !== null) {\n    customFields_customer = Object.keys(customFields.customer_custom_fields) || [];\n    customFields_subscription = Object.keys(customFields.subscription_custom_fields) || [];\n}\nconsole.log(fields.subscriptionFields);\nconsole.log();\n\nlet card = {\n    \"cards\": [\n        {\n            \"id\": \"mainCard\",\n            \"card\": {\n                \"type\": \"EMPTY_BACKGROUND\",\n                \"heading\": \"Sync Fields from Chargebee to Pipedrive\",\n                \"contents\": [\n                    \"Set rules to sync customer and subscription fields from Chargebee to Pipedrive.\"\n                ],\n        \"message\": {\n            \"message\":(linkSubAttributesToPerson === \"option1\") ? \"We will sync 10 fields from Chargebee to Pipedrive. You can sync more fields by enabling the configuration below. The subscription fields will be synced as attributes to person in Pipedrive.\" : \"We will sync 10 fields from Chargebee to Pipedrive. You can sync more fields by enabling the configuration below.The subscription fields will be synced as attributes of organization in Pipedrive. \",\n            \"messageLook\": \"INFO\",\n            \"button\": {\n                \"display\": \"View Fields\",\n                \"icon\": \"ARROW\",\n                \"url\": \"https://www.chargebee.com/docs/index.html\",\n                \"id\": \"viewFields\",\n                \"type\": \"DIRECT_LINK\",\n                \"newTab\": \"true\"\n            }\n        }\n            },\n            \"isCardDone\": \"true\"\n        },\n        {\n            \"card\": {\n                \"type\": \"TOGGLE_HIDE_INPUT\",\n                \"params\": [\n                    {\n                        \"dispName\": \"Sync more fields from Chargebee to Pipedrive\",\n                        \"req\": \"true\",\n                        \"type\": \"TOGGLE\",\n                        \"id\": \"syncMoreFields\",\n                         \"defaultVal\": ((fields.subscriptionFields && fields.subscriptionFields.length > 0 ) || (fields.personFields && fields.personFields.length > 0)) ? \"true\" : \"false\"\n                    },\n                    {\n                        \"dispName\": \"Subscription fields\",\n                        \"type\": \"MODELBOX_INPUT_FIELDS\",\n                        \"id\": \"subscriptionFields\",\n                        \"inputFields\": [\n                            {\n                                \"type\": \"SEARCH_CHECK_BOX\",\n                                \"id\": \"subscriptionFieldsSelected\",\n                                \"checkboxes\": [\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_ID\",\n                                        \"desc\": \"Id\",\n                                        \"defaultVal\":(fields.subscriptionFields  && fields.subscriptionFields.indexOf('CB_Subscription_ID') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Currency\",\n                                        \"desc\": \"Currency\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Currency') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Plan_Name\",\n                                        \"desc\": \"Plan Name\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Plan_Name') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Status\",\n                                        \"desc\": \"Status\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Status') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Created_At\",\n                                        \"desc\": \"Created At\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf(\"CB_Subscription_Created_At\") > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Trial_start\",\n                                        \"desc\": \"Trial Start\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Trial_start') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Trial_end\",\n                                        \"desc\": \"Trial End\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Trial_end') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Started_At\",\n                                        \"desc\": \"Started At\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Started_At') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Activated_At\",\n                                        \"desc\": \"Activated At\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Activated_At') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Pause_At\",\n                                        \"desc\": \"Pause At\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Pause_At') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Resume_At\",\n                                        \"desc\": \"Resume At\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Resume_At') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Next_Billing_At\",\n                                        \"desc\": \"Next Billing At\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Next_Billing_At') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Start_At\",\n                                        \"desc\": \"Start At\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Start_At') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Cancelled_At\",\n                                        \"desc\": \"Cancelled At\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Cancelled_At') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Cancel_Reason\",\n                                        \"desc\": \"Cancel Reason\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Cancel_Reason') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Current_term_start\",\n                                        \"desc\": \"Current Term Start\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Current_term_start') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_Current_term_end\",\n                                        \"desc\": \"Current Term End\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_Current_term_end') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_MRR\",\n                                        \"desc\": \"MRR\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_MRR') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Subscription_CMRR\",\n                                        \"desc\": \"CMRR\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Subscription_CMRR') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Gift_Subscription\",\n                                        \"desc\": \"Is Gift\",\n                                        \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf('CB_Gift_Subscription') > -1 ? \"on\" : \"off\")\n                                    }\n                                ]\n                            }\n                        ]\n                    },\n                    {\n                        \"dispName\": \"Customer fields\",\n                        \"type\": \"MODELBOX_INPUT_FIELDS\",\n                        \"id\": \"customerFields\",\n                        \"inputFields\": [\n                            {\n                                \"type\": \"SEARCH_CHECK_BOX\",\n                                \"id\": \"customerFieldsSelected\",\n                                \"checkboxes\": [\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Customer_Auto Collection\",\n                                        \"desc\": \"Auto Collection\",\n                          \"defaultVal\":(fields.personFields && fields.personFields.indexOf('CB_Customer_Auto Collection') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Customer_Locale\",\n                                        \"desc\": \"Customer Locale\",\n                                        \"defaultVal\":(fields.personFields && fields.personFields.indexOf('CB_Customer_Locale') > -1 ? \"on\" : \"off\")\n                                    },\n                                    {\n                                        \"type\": \"CHECKBOX\",\n                                        \"id\": \"CB_Customer_Total_Due_Amount\",\n                                        \"desc\": \"Total Due Amount\",\n                                        \"defaultVal\":(fields.personFields && fields.personFields.indexOf('CB_Customer_Total_Due_Amount') > -1 ? \"on\" : \"off\")\n                                    }\n                                ]\n                            }\n                        ]\n                    }\n                ]\n            },\n            \"id\": \"check4\",\n            \"isCardDone\": \"true\"\n        }\n    ],\n    \"proceed\": {\n        \"id\": \"proceed\",\n        \"display\": \"Proceed\",\n        \"icon\": \"ARROW\",\n        \"buttonLook\": \"FILLED\",\n        \"type\": \"DIRECT_LINK\",\n        \"request\": {\n            \"type\": \"ON_CLICK_SEND_INPUT\",\n            \"apiEndPoint\": {\n                \"apiUrl\": cloudElementsUrl + \"/pipedrive/syncFieldsConfig\",\n                \"type\": \"GET\",\n                \"headers\": {\n                    \"Elements-Formula-Instance-Id\": syncFieldsConfigInstance\n                },\n                \"input\": {\n                    \"id\": \"chargebee\"\n                }\n            }\n        }\n    }\n}\n\nlet temp;\n\nif (customFields_customer.length > 0) {\n    for (var i = 0; i < customFields_customer.length; i++) {\n        temp = {\n            \"type\": \"CHECKBOX\",\n            \"id\": customFields_customer[i],\n            \"desc\": customFields.customer_custom_fields[customFields_customer[i]],\n            \"defaultVal\":(fields.personFields && fields.personFields.indexOf(customFields_customer[i]) > -1 ? \"on\" : \"off\")\n        }\n        card.cards[1].card.params[2].inputFields[0].checkboxes.push(temp);\n    }\n}\n\nif (customFields_subscription.length > 0) {\n\n    for (var j = 0; j < customFields_subscription.length; j++) {\n        temp = {\n            \"type\": \"CHECKBOX\",\n            \"id\": customFields_subscription[j],\n            \"desc\": customFields.subscription_custom_fields[customFields_subscription[j]],\n            \"defaultVal\":(fields.subscriptionFields && fields.subscriptionFields.indexOf(customFields_subscription[j]) > -1 ? \"on\" : \"off\")\n        }\n        card.cards[1].card.params[2].inputFields[0].checkboxes.push(temp);\n    }\n}\n\n\n\n\ndone(card);"}}],"triggers":[{"id":26035,"onSuccess":["EnvProps"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"method":"GET","uri":"/pipedrive/syncFieldsSetup","engine":"v1","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"api":"GET /pipedrive/syncFieldsSetup","configuration":[]}