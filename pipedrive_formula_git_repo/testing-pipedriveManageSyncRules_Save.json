{"id":29427,"name":"testing-pipedriveManageSyncRules_Save","userId":27893,"accountId":24428,"createdDate":"2019-09-05T07:12:57Z","steps":[{"id":227295,"onSuccess":[],"onFailure":[],"name":"Failed","type":"script","properties":{"body":"let card = {\n \"status\": \"error\",\n \"notice\" : \"Invalid Fields Selected for Mapping.\"\n};\n\ndone({\n  statusCode: 200,\n  result: card\n});"}},{"id":216438,"onSuccess":["updateTpConfig_params"],"onFailure":[],"name":"getTpConfig","type":"httpRequest","properties":{"retryDelay":"200","query":"${steps.InputParams.getTpConfigParams.query}","url":"${steps.InputParams.getTpConfigParams.url}","headers":"${steps.InputParams.getTpConfigParams.auth}","retry":"true","retryAttempts":"5","method":"GET"}},{"id":216439,"onSuccess":["getTpConfig"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let apiKey = trigger.args['cb-api-key'];\nlet siteName = trigger.args['cb-site-name'];\nlet integrationName = trigger.args['integrationName'];\nlet siteDomain = trigger.args['cb-domain'];\nlet password = \"\";\n\nlet errorEmailEndpoint =  'https://' + siteName + '.' + siteDomain + '/adhoc_checkout_email/api/send';\n// let errorEmailAddress = \"integrations-growth-internal@chargebee.com\";\nlet errorEmailAddress = \"ajaitester@gmail.com\";\n\nlet getTpConfigParams = {\n    url: \"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_configurations\",\n    auth:{\n      Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password)\n    },\n    query:{\n      integration_name: integrationName\n    }\n};\n\nlet updateTpConfigParams = {\n  url: \"https://\"+siteName+\".integrations.\"+siteDomain+\"/integrations/update_tp_integ_conf\",\n  headers: {\n    \"Content-Type\": \"application/json\",\n    \"cache-control\": \"no-cache\"\n  },\n  body: {\n     site_name: siteName,\n     api_key: apiKey,\n     integration_name: integrationName\n     //append config_json with this during request\n  }\n};\n\nlet sendErrorMailParams = {\n  url: errorEmailEndpoint,\n  headers:{\n    Authorization: \"Basic \" + CE.b64(apiKey + \":\" + \"\")\n  },\n  query :{\n    content : \"Integration Error, Formula-Instance-ID : \",\n    subject : \"Fatal Error Occurred during \" + integrationName + \" Initial Sync\",\n    to_address : errorEmailAddress,\n    api_key : apiKey\n  }\n};\n\nlet params = {\n  input: {\n    apiKey: apiKey,\n    siteName: siteName,\n    siteDomain:siteDomain,\n    integrationName: integrationName,\n    errorEmailEndpoint: errorEmailEndpoint,\n    errorEmailAddress: errorEmailAddress\n  }\n};\n\ndone({\n  params: params,\n  getTpConfigParams: getTpConfigParams,\n  updateTpConfigParams: updateTpConfigParams,\n  sendErrorMailParams: sendErrorMailParams\n});"}},{"id":227294,"onSuccess":["InputParams"],"onFailure":["Failed"],"name":"isMappedFieldsValid","type":"filter","properties":{"body":"if(trigger.args.request.query['mapField_chargebee'] === \"email\"){\n  if(trigger.args.request.query['mapField_pipedrive'] === \"email\"){\n    done(true);\n  }else{\n    done(false);\n  }\n}\n\nif(trigger.args.request.query['mapField_chargebee'] === \"id\"){\n  if(trigger.args.request.query['mapField_pipedrive'] === \"email\"){\n    done(false);\n  }else{\n    done(true);\n  }\n}\n\n\ndone(true);"}},{"id":216440,"onSuccess":[],"onFailure":[],"name":"Success","type":"script","properties":{"body":"done({\n  statusCode: 200\n});"}},{"id":216441,"onSuccess":["Success"],"onFailure":[],"name":"updateTpConfig","type":"httpRequest","properties":{"retryDelay":"200","body":"${steps.updateTpConfig_params.updateTpConfig.body}","url":"${steps.updateTpConfig_params.updateTpConfig.url}","headers":"${steps.updateTpConfig_params.updateTpConfig.headers}","retry":"true","retryAttempts":"5","method":"POST"}},{"id":216442,"onSuccess":["updateTpConfig"],"onFailure":[],"name":"updateTpConfig_params","type":"script","properties":{"body":"// steps.getTpConfig.response.body.third_party_configuration.config_json.new_sub_step = \"completed\";\n\nlet configJson = steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements;\n\n// Clearing Existing Configurations\n\nconfigJson.syncRulesContacts = null;\nconfigJson.syncRulesDeals = null;\nconfigJson.syncFields.personFields = [];\nconfigJson.syncFields.subscriptionFields = [];\n\n// configJson.syncRulesContacts = {\n//   \"chooseCustomersToSync\" : (trigger.args.chooseCustomersToSync !== undefined) ? trigger.args.chooseCustomersToSync : null,\n//   \"createPeopleInPipedrive\" : (trigger.args.createPeopleInPipedrive !== undefined) ? trigger.args.createPeopleInPipedrive : \"false\",\n//   \"manageOrganizationInPipedrive\" : (trigger.args.manageOrganizationInPipedrive !== undefined) ? trigger.args.manageOrganizationInPipedrive : \"false\",\n//   \"actionCustomerSyncedToPipedrive\": (trigger.args.actionCustomerSyncedToPipedrive !== undefined) ? trigger.args.actionCustomerSyncedToPipedrive : null,\n//   \"linkSubAttributesToPerson\": (trigger.args.linkSubAttributesToPerson !== undefined) ? trigger.args.linkSubAttributesToPerson : null,\n//   \"syncAccountHierarchies\": (trigger.args.syncAccountHierarchies !== undefined) ? trigger.args.syncAccountHierarchies : \"false\",\n//   \"customerDeletedInCB\": (trigger.args.customerDeletedInCB !== undefined) ? trigger.args.customerDeletedInCB : \"option2\",\n//   \"mappedField\": ((trigger.args.mappedField !== undefined) && (trigger.args.mappedField === \"option1\")) ? \"email\" : \"customer_id\"\n// };\n\nconfigJson.syncRulesContacts = {\n  \"chooseCustomersToSync\" : (trigger.args.chooseCustomersToSync !== undefined) ? trigger.args.chooseCustomersToSync : null,\n  \"createPeopleInPipedrive\" : (trigger.args.createPeopleInPipedrive !== undefined) ? trigger.args.createPeopleInPipedrive : \"false\",\n  \"manageOrganizationInPipedrive\" : (trigger.args.manageOrganizationInPipedrive !== undefined) ? trigger.args.manageOrganizationInPipedrive : \"false\",\n  \"actionCustomerSyncedToPipedrive\": (trigger.args.actionCustomerSyncedToPipedrive !== undefined) ? trigger.args.actionCustomerSyncedToPipedrive : undefined,\n  \"linkSubAttributesToPerson\": (trigger.args.linkSubAttributesToPerson !== undefined) ? trigger.args.linkSubAttributesToPerson : \"option1\",\n  \"syncAccountHierarchies\": (trigger.args.syncAccountHierarchies !== undefined) ? trigger.args.syncAccountHierarchies : undefined,\n  \"customerDeletedInCB\": (trigger.args.customerDeletedInCB !== undefined) ? trigger.args.customerDeletedInCB : \"option2\",\n  \"mappedField\": (trigger.args.mapField_chargebee !== undefined) ? trigger.args.mapField_chargebee : steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.syncRulesContacts.mappedField,\n  \"mappedField_pipedrive\": (trigger.args.mapField_pipedrive !== undefined) ? trigger.args.mapField_pipedrive : steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.syncRulesContacts.mappedField_pipedrive\n};\n\n\nconfigJson.syncRulesDeals = {\n  \"subCreated\" : (trigger.args.subCreated !== undefined) ? trigger.args.subCreated : \"option1\",\n  \"subCreatedPipeline\" : (trigger.args.subCreatedPipeline !== undefined) ? trigger.args.subCreatedPipeline : \"option1\",\n  \"subCreatedStage\" : (trigger.args.subCreatedStage !== undefined) ? trigger.args.subCreatedStage : \"option1\",\n  \n  \"subUpdated\" : (trigger.args.subUpdated !== undefined) ? trigger.args.subUpdated : \"option1\",\n  \"subUpdatedPipeline\" : (trigger.args.subUpdatedPipeline !== undefined) ? trigger.args.subUpdatedPipeline : \"option1\",\n  \"subUpdatedStage\" : (trigger.args.subUpdatedStage !== undefined) ? trigger.args.subUpdatedStage : \"option1\",\n  \n  \"subDeleted\" : (trigger.args.subDeleted !== undefined) ? trigger.args.subDeleted : \"option1\",\n  \"subDeletedPipeline\" : (trigger.args.subDeletedPipeline !== undefined) ? trigger.args.subDeletedPipeline : \"option1\",\n  \"subDeletedStage\" : (trigger.args.subDeletedStage !== undefined) ? trigger.args.subDeletedStage : \"option1\",\n  \n  \"subPaused\" : (trigger.args.subPaused !== undefined) ? trigger.args.subPaused : \"option1\",\n  \"subPausedPipeline\" : (trigger.args.subPausedPipeline !== undefined) ? trigger.args.subPausedPipeline : \"option1\",\n  \"subPausedStage\" : (trigger.args.subPausedStage !== undefined) ? trigger.args.subPausedStage : \"option1\",\n  \n  \"subResumed\" : (trigger.args.subResumed !== undefined) ? trigger.args.subResumed : \"option1\",\n  \"subResumedPipeline\" : (trigger.args.subResumedPipeline !== undefined) ? trigger.args.subResumedPipeline : \"option1\",\n  \"subResumedStage\" : (trigger.args.subResumedStage !== undefined) ? trigger.args.subResumedStage : \"option1\",\n  \n  \"subCancelled\" : (trigger.args.subCancelled !== undefined) ? trigger.args.subCancelled : \"option1\",\n  \"subCancelledPipeline\" : (trigger.args.subCancelledPipeline !== undefined) ? trigger.args.subCancelledPipeline : \"option1\",\n  \"subCancelledStage\" : (trigger.args.subCancelledStage !== undefined) ? trigger.args.subCancelledStage : \"option1\",\n  \n  \"subReactivated\" : (trigger.args.subReactivated !== undefined) ? trigger.args.subReactivated : \"option1\",\n  \"subReactivatedPipeline\" : (trigger.args.subReactivatedPipeline !== undefined) ? trigger.args.subReactivatedPipeline : \"option1\",\n  \"subReactivatedStage\" : (trigger.args.subReactivatedStage !== undefined) ? trigger.args.subReactivatedStage : \"option1\",\n  \n  \"howToUpdateDealValue\" : (trigger.args.howToUpdateDealValue !== undefined) ? trigger.args.howToUpdateDealValue : \"option1\",\n  \"addNotesSubscription\" : (trigger.args.addNotesSubscription !== undefined) ? trigger.args.addNotesSubscription : \"false\",\n  \n  \"invCreated\" : (trigger.args.invCreated !== undefined) ? trigger.args.invCreated : \"option1\",\n  \"invCreatedPipeline\" : (trigger.args.invCreatedPipeline !== undefined) ? trigger.args.invCreatedPipeline : \"option1\",\n  \"invCreatedStage\" : (trigger.args.invCreatedStage !== undefined) ? trigger.args.invCreatedStage : \"option1\",\n  \n  \"invDeleted\" : (trigger.args.invDeleted !== undefined) ? trigger.args.invDeleted : \"option1\",\n  \"invDeletedPipeline\" : (trigger.args.invDeletedPipeline !== undefined) ? trigger.args.invDeletedPipeline : \"option1\",\n  \"invDeletedStage\" : (trigger.args.invDeletedStage !== undefined) ? trigger.args.invDeletedStage : \"option1\",\n  \n  \"invPaid\" : (trigger.args.invPaid !== undefined) ? trigger.args.invPaid : \"option1\",\n  \"invPaidPipeline\" : (trigger.args.invPaidPipeline !== undefined) ? trigger.args.invPaidPipeline : \"option1\",\n  \"invPaidStage\" : (trigger.args.invPaidStage !== undefined) ? trigger.args.invPaidStage : \"option1\",\n  \n  \"invVoided\" : (trigger.args.invVoided !== undefined) ? trigger.args.invVoided : \"option1\",\n  \"invVoidedPipeline\" : (trigger.args.invVoidedPipeline !== undefined) ? trigger.args.invVoidedPipeline : \"option1\",\n  \"invVoidedStage\" : (trigger.args.invVoidedStage !== undefined) ? trigger.args.invVoidedStage : \"option1\",\n  \n  \"updateDealValueWithInvoice\" : (trigger.args.updateDealValueWithInvoice !== undefined) ? trigger.args.updateDealValueWithInvoice : \"false\",\n  \"addNotesInvoice\" : (trigger.args.addNotesInvoice !== undefined) ? trigger.args.addNotesInvoice : \"false\"\n};\n\nlet customerFields = (trigger.args.customerFields !== \"\") ? JSON.parse(trigger.args.customerFields) : null;\nlet customerFieldsSelected = (customerFields !== null) ? JSON.parse(customerFields.customerFieldsSelected) : null;\n\nlet personFields = (customerFieldsSelected !== null) ? Object.keys(customerFieldsSelected) : [];\n\nlet subscriptionFieldsInput = (trigger.args.customerFields !== \"\") ? JSON.parse(trigger.args.subscriptionFields) : null;\nlet subscriptionFieldsSelected = (subscriptionFieldsInput !== null) ? JSON.parse(subscriptionFieldsInput.subscriptionFieldsSelected) : null;\n\nlet subscriptionFields = (subscriptionFieldsSelected !== null) ? Object.keys(subscriptionFieldsSelected) : [];\n\nconfigJson.syncFields.personFields = personFields;\nconfigJson.syncFields.subscriptionFields = subscriptionFields;\n\n// steps.getTpConfig.response.body.third_party_configuration.config_json[\"new_sub_step\"] = \"completed\";\n\nlet config_json = {\n  cloudElements : configJson,\n  new_sub_step : \"completed\"\n};\n\nlet updateTpConfig = steps.InputParams.updateTpConfigParams;\nupdateTpConfig.body.config_json = config_json;\n// updateTpConfig.body.config_json.cloudElements = configJson;\n// updateTpConfig.body.config_json.new_sub_step = \"completed\";\n\ndone({\n  updateTpConfig: updateTpConfig\n});"}}],"triggers":[{"id":26054,"onSuccess":["isMappedFieldsValid"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"method":"POST","uri":"/pipedrive/saveSyncRules","engine":"v1","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"api":"POST /pipedrive/saveSyncRules","configuration":[]}