{"id":29424,"name":"testing-pipedriveConnect","userId":27893,"accountId":24428,"createdDate":"2019-09-05T07:11:36Z","steps":[{"id":216397,"onSuccess":["noError"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let apiKey = trigger.args.request.query['cb-api-key'];\nlet siteName = trigger.args.request.query['cb-site-name'];\nlet integrationName = trigger.args.request.query['integrationName'];\nlet siteDomain = trigger.args.request.query['cb-domain'];\nlet chargebeeElement = trigger.args.request.query['chargebeeElement'];\nlet thirdPartyElement = trigger.args.request.query['thirdPartyElement'];\n\nlet errorEmailEndpoint =  'https://' + siteName + '.' + siteDomain + '/adhoc_checkout_email/api/send';\nlet errorEmailAddress = \"integrations-growth-internal@chargebee.com\";\n\nlet client_info = JSON.parse(trigger.args.request.query['client_info']);\n\nlet client_id = client_info.client_id;\nlet client_secret = client_info.client_secret;\nlet redirect_url = client_info.redirect_url;\nlet state = trigger.args.request.query['cb-site-name'];\n\nlet params = {\n  input: {\n    apiKey: apiKey,\n    siteName: siteName,\n    siteDomain:siteDomain,\n    integrationName: integrationName,\n    errorEmailEndpoint: errorEmailEndpoint,\n    errorEmailAddress: errorEmailAddress,\n    chargebeeElement: chargebeeElement,\n    thirdPartyElement: thirdPartyElement,\n    state:state,\n    client_id: client_id,\n    client_secret: client_secret,\n    redirect_url: redirect_url\n  }\n};\n\n\nlet error = null;\n\nif(apiKey===undefined) {\n  error +=  \"apiKey  undefined,\";\n}\nif(siteName===undefined) {\n  error +=  \"siteName undefined,\";\n}\nif(integrationName===undefined) {\n  error += \"type  undefined,\";\n}\nif(chargebeeElement===undefined) {\n  error += \"chargebeeElement undefined,\";\n}\nif(thirdPartyElement===undefined) {\n  error += \"thirdPartyElement undefined,\";\n}\n\n\nlet sendErrorMailParams = {\n  url: errorEmailEndpoint,\n  headers:{\n    Authorization: \"Basic \" + CE.b64(apiKey + \":\" + \"\")\n  },\n  query :{\n    content : \"Integration Error, Formula-Instance-ID : \" + trigger.args.request.headers['elements-formula-instance-id'],\n    subject : \"Fatal Error Occurred during \" + integrationName + \" Sync\",\n    to_address : errorEmailAddress,\n    api_key : apiKey\n  }\n};\n\n\nlet tpConfigUpdateParams = {\n  url: \"https://\"+siteName+\".integrations.\"+siteDomain+\"/integrations/update_tp_integ_conf\",\n  headers: {\n    \"Content-Type\": \"application/json\",\n    \"cache-control\": \"no-cache\"\n  },\n  body:  {\n     site_name: siteName,\n     api_key: apiKey,\n     integration_name: integrationName\n  }\n}\n\ndone({\n  error : error,\n  params: params,\n  sendErrorMailParams: sendErrorMailParams,\n  tpConfigUpdateParams: tpConfigUpdateParams\n});"}},{"id":216398,"onSuccess":["updateTpConfig_params"],"onFailure":["sendErrorMail"],"name":"noError","type":"filter","properties":{"body":"if(steps.InputParams.error !== null){\n  done(false);\n}\n\ndone(true);"}},{"id":216399,"onSuccess":[],"onFailure":[],"name":"sendErrorCard","type":"script","properties":{"body":"let card = {\n    \"cards\": [{\n        \"id\": \"check2\",\n        \"card\": {\n            \"type\": \"ACTION\",\n            \"heading\": \"Integration Error:  Initialization Failed\",\n            \"listContent\": [\n                \"Integration Error:  Initialization Failed, \"+steps.InputParams.error\n            ],\n            \"icon\": \"WARNING\"\n          \n        }\n    }]\n}\n\ndone({\n  statusCode: 200,\n  result: card\n})"}},{"id":216400,"onSuccess":["sendErrorCard"],"onFailure":[],"name":"sendErrorMail","type":"httpRequest","properties":{"method":"POST","query":"${steps.InputParams.sendErrorMailParams.query}","retryAttempts":"5","headers":"${steps.InputParams.sendErrorMailParams.headers}","retryDelay":"200","url":"${steps.InputParams.sendErrorMailParams.url}","retry":"true"}},{"id":216401,"onSuccess":[],"onFailure":[],"name":"Success","type":"script","properties":{"body":"let connectCard = {\n\t\"contents\":[\n\t\t\"Pipedrive is a sales-focused CRM that lets you streamline your sales process. With this integration, you can keep a tab on your sales pipeline, build a target audience, automate deal creation, and more. Pipedrive also allows you to view the progress of your leads, monitor the performance of your sales team, and track the deals offered to customers.\",\n\t\t\"Integrate now to sync your customer and subscription data with Pipedrive.<a href=\\\"\\\" target=\\\"blank\\\">Learn more</a>\"\n\t],\n\t\"message\":{\n    \"message\":\"Chargebee will sync customers and subscription details with Pipedrive as per your configurations.\",\n    \"icon\":\"INFO\",\n    \"messageLook\":\"INFO\",\n    \"boxNeeded\":\"false\",\n    \"button\": {\n    \t\t\"display\": \"Read Privacy Policy\",\n    \t\t\"icon\": \"OPENINNEW\",\n    \t\t \"url\":\"https://www.chargebee.com/docs/index.html\",\n    \t\t \"id\": \"readprivacy\",\n    \t\t\"type\": \"DIRECT_LINK\",\n    \t\t\"newTab\":\"true\"       \n  \t}\n  },\n\t\"docUrl\":\"\",\n\t\"signupUrl\":\"https://www.pipedrive.com/en/register\",\n\t\"requestType\": \"oauthredirect\",\n\t\"connect\":{\n\t\t\"id\":\"credentials\",\n\t\t\"display\" : \"Connect\",\n\t\t\"icon\" : \"ARROW\",\n\t\t\"buttonLook\":\"FILLED\",\n\t\t\"type\" : \"DIRECT_LINK\",\n\t\t\"redirectUrl\" : \"https://oauth.pipedrive.com/oauth/authorize?client_id=\"+steps.InputParams.params.input.client_id+\"&state=\"+steps.InputParams.params.input.state+\"&redirect_uri=\"+steps.InputParams.params.input.redirect_url,\n\t\t\"request\":{\n      \"type\":\"ON_CLICK_DEFAULT_ACTION\"\n    }\n\t}\n};\n\ndone({\n  statusCode: 200,\n  result: connectCard\n});\n\n\n\n\n"}},{"id":216402,"onSuccess":["Success"],"onFailure":["sendErrorMail"],"name":"updateTpConfig","type":"httpRequest","properties":{"method":"POST","retryAttempts":"5","body":"${steps.updateTpConfig_params.tpConfigUpdateParams.body}","headers":"${steps.updateTpConfig_params.tpConfigUpdateParams.headers}","retryDelay":"200","url":"${steps.updateTpConfig_params.tpConfigUpdateParams.url}","retry":"true"}},{"id":216403,"onSuccess":["updateTpConfig"],"onFailure":[],"name":"updateTpConfig_params","type":"script","properties":{"body":"let configJson = {\n  cloudElements: {\n    initParams : trigger.args.request.query,\n    \"new_sub_step\": \"step_1\"\n}\n};\n\nlet tpConfigUpdateParams = steps.InputParams.tpConfigUpdateParams;\ntpConfigUpdateParams.body.config_json = configJson;\n\ndone({\n  tpConfigUpdateParams: tpConfigUpdateParams\n});\n\n"}}],"triggers":[{"id":26051,"onSuccess":["InputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"method":"GET","uri":"/pipedrive/connect","engine":"v1","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"api":"GET /pipedrive/connect","configuration":[]}