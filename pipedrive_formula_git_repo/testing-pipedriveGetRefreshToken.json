{"id":29422,"name":"testing-pipedriveGetRefreshToken","userId":27893,"accountId":24428,"createdDate":"2019-09-05T07:10:26Z","steps":[{"id":216384,"onSuccess":[],"onFailure":[],"name":"bf","type":"script","properties":{"body":"done({\n  statusCode: 401,\n  result : \"Failed\"\n});"}},{"id":216385,"onSuccess":[],"onFailure":[],"name":"Failed","type":"script","properties":{"body":"done({\n  statusCode: 400,\n  result : \"Failed\"\n});"}},{"id":216386,"onSuccess":["getThirdPartyInstanceDetails"],"onFailure":["Failed"],"name":"getNewToken","type":"httpRequest","properties":{"url":"${steps.getNewToken_params.payload.url}","method":"POST","retry":"true","query":"","path":"","form":"","retryAttempts":"5","body":"${steps.getNewToken_params.payload.body}","acceptableStatusCodes":"200","headers":"${steps.getNewToken_params.payload.headers}","retryDelay":"200"}},{"id":216387,"onSuccess":["getNewToken"],"onFailure":[],"name":"getNewToken_params","type":"script","properties":{"body":"if(steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.OAuth_Parameters === undefined){\n  done(false);\n}\n\n\nlet params = steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.OAuth_Parameters;\n\nlet payload = {\n  url: \"https://oauth.pipedrive.com/oauth/token\",\n  headers : {\n    \"Content-Type\" : \"application/x-www-form-urlencoded\",\n    \"Authorization\" : \"Basic \" + CE.b64(params.client_info.client_id + \":\" + params.client_info.client_secret)\n  },\n  body : \"grant_type=refresh_token&refresh_token=\" + params.refresh_token\n};\n\ndone({\n  payload: payload\n});"}},{"id":216388,"onSuccess":["updateElementInstanceParams"],"onFailure":[],"name":"getThirdPartyInstanceDetails","type":"request","properties":{"method":"GET","api":"/instances/${steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.thirdParty.instance}"}},{"id":216389,"onSuccess":["getNewToken_params"],"onFailure":[],"name":"getTpConfig","type":"httpRequest","properties":{"url":"${steps.InputParams.getTpConfigParams.url}","method":"GET","retry":"false","query":"${steps.InputParams.getTpConfigParams.query}","headers":"${steps.InputParams.getTpConfigParams.auth}"}},{"id":216390,"onSuccess":["getTpConfig"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let apiKey = trigger.args['apiKey'];\nlet siteName = trigger.args['siteName'];\nlet siteDomain = trigger.args['siteDomain'];\n// let integration_name = trigger.args['integration_name'];\nlet integration_name = \"pipedrive\";\nlet password = trigger.args['password'];\n\n\n\nlet params = {\n  input:{\n    apiKey: apiKey,\n    siteName: siteName,\n    siteDomain: siteDomain,\n    integration_name: integration_name,\n    password: password\n  }\n};\n\n\nlet getTpConfigParams = {\n  url: \"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_configurations\",\n  auth:{\n    Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password)\n  },\n  query:{\n    integration_name: integration_name\n  }\n}\n\ndone({\n  params: params,\n  getTpConfigParams: getTpConfigParams\n});"}},{"id":216391,"onSuccess":[],"onFailure":[],"name":"Success","type":"script","properties":{"body":"done({\n  statusCode: 200,\n  result : {\n    \"OAuthDetails\" : steps.updateTpConfig_params.OAuthDetails\n  }\n});"}},{"id":216392,"onSuccess":["updateThirdPartyInstance"],"onFailure":[],"name":"updateElementInstanceParams","type":"script","properties":{"body":"let thirdPartyElementId = steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.thirdParty.instance || null;\n\nlet config = steps.getThirdPartyInstanceDetails.response.body;\n\nlet accessToken  = steps.getNewToken.response.body.access_token;\nlet tokenType = steps.getNewToken.response.body.token_type;\n\nconfig.configuration['access_token'] = tokenType + \" \" + accessToken;\n\nlet updateParams={\n  url: \"/instances/\"+thirdPartyElementId,\n  body: config\n};\n\ndone({\n  updateParams: updateParams\n});"}},{"id":216393,"onSuccess":["updateTpConfig_params"],"onFailure":[],"name":"updateThirdPartyInstance","type":"request","properties":{"method":"PUT","api":"${steps.updateElementInstanceParams.updateParams.url}","body":"${steps.updateElementInstanceParams.updateParams.body}"}},{"id":216394,"onSuccess":["Success"],"onFailure":[],"name":"updateTpConfig","type":"httpRequest","properties":{"url":"${steps.updateTpConfig_params.updateTpConfigParams.url}","method":"POST","retry":"true","retryAttempts":"5","body":"${steps.updateTpConfig_params.updateTpConfigParams.body}","headers":"${steps.updateTpConfig_params.updateTpConfigParams.headers}","retryDelay":"200"}},{"id":216395,"onSuccess":["updateTpConfig"],"onFailure":[],"name":"updateTpConfig_params","type":"script","properties":{"body":"let configuration=steps.getTpConfig.response.body.third_party_configuration.config_json;\n\nconfiguration.cloudElements.OAuth_Parameters.access_token = steps.getNewToken.response.body.token_type + \" \" + steps.getNewToken.response.body.access_token;\nconfiguration.cloudElements.OAuth_Parameters.expiry_time = Math.round((new Date().getTime())/1000) + Number(steps.getNewToken.response.body.expires_in);\nconfiguration.cloudElements.OAuth_Parameters.refresh_token = steps.getNewToken.response.body.refresh_token;\nconfiguration.cloudElements.OAuth_Parameters.scope = steps.getNewToken.response.body.scope;\nconfiguration.cloudElements.OAuth_Parameters.token_type = steps.getNewToken.response.body.token_type;\n\nlet updateTpConfigParams = {\n  url: \"https://\"+steps.InputParams.params.input.siteName+\".integrations.\"+steps.InputParams.params.input.siteDomain+\"/integrations/update_tp_integ_conf\",\n  headers: {\n    \"Content-Type\": \"application/json\",\n    \"cache-control\": \"no-cache\"\n  },\n  body: {\n     site_name: steps.InputParams.params.input.siteName,\n     api_key: steps.InputParams.params.input.apiKey,\n     integration_name: steps.InputParams.params.input.integration_name,\n     config_json: configuration\n  }\n};\n\ndone({\n  updateTpConfigParams: updateTpConfigParams,\n  OAuthDetails : configuration.cloudElements.OAuth_Parameters\n});\n\n\n"}}],"triggers":[{"id":26049,"onSuccess":["InputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"engine":"v3","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"configuration":[]}