{"id":29408,"name":"testing-pipedriveSyncFieldsConfig","userId":27893,"accountId":24428,"createdDate":"2019-09-05T06:59:23Z","steps":[{"id":215743,"onSuccess":["tpConfigPayload"],"onFailure":[],"name":"getTpConfig","type":"httpRequest","properties":{"method":"GET","url":"${steps.InputParams.getTpConfigParams.url}","query":"${steps.InputParams.getTpConfigParams.query}","body":"","headers":"${steps.InputParams.getTpConfigParams.auth}"}},{"id":215744,"onSuccess":["getTpConfig"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let apiKey = trigger.args.request.query['cb-api-key'] || null;\nlet siteName = trigger.args.request.query['cb-site-name'] || null;\nlet siteDomain = trigger.args.request.query['cb-domain'];\nlet integration_name = \"pipedrive\";\nlet password = \"\";\n\nlet customerFields;\nlet customerFieldsSelected;\nlet personFields = [];\n\nlet subscriptionFieldsInput;\nlet subscriptionFieldsSelected;\nlet subscriptionFields = [];\n\nif((trigger.args.request.query['customerFields'] !== undefined) && (trigger.args.request.query['customerFields'] !== \"\")){\n  customerFields = JSON.parse(trigger.args.request.query['customerFields']) || null;\n  customerFieldsSelected = JSON.parse(customerFields.customerFieldsSelected) || null;\n  if(customerFieldsSelected !== null)\n    personFields = Object.keys(customerFieldsSelected) || null;\n}\n\nif((trigger.args.request.query['subscriptionFields'] !== undefined) && (trigger.args.request.query['subscriptionFields'] !== \"\")){\n  let subscriptionFieldsInput = JSON.parse(trigger.args.request.query['subscriptionFields']) || null;\n  let subscriptionFieldsSelected = JSON.parse(subscriptionFieldsInput.subscriptionFieldsSelected) || null;\n  if(subscriptionFieldsSelected !== null)\n    subscriptionFields = Object.keys(subscriptionFieldsSelected) || null;\n}\n\n\nlet params={\n  input:{\n    apiKey: apiKey,\n    siteName: siteName,\n    siteDomain: siteDomain,\n    integration_name: integration_name,\n    password: password\n  },\n  configParams:{\n    personFields: personFields,\n    subscriptionFields: subscriptionFields\n  }\n};\n\n\nlet getTpConfigParams = {\n  url: \"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_configurations\",\n  auth:{\n    Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password)\n  },\n  query:{\n    integration_name: integration_name\n  }\n}\n\ndone({\n  params:params,\n  getTpConfigParams: getTpConfigParams\n});\n\n"}},{"id":215745,"onSuccess":[],"onFailure":[],"name":"Success","type":"script","properties":{"body":"let response = trigger.args.request.query;\n\ndone({\n  statusCode: 200,\n  result: response\n});"}},{"id":215746,"onSuccess":["updateTpConfig"],"onFailure":[],"name":"tpConfigPayload","type":"script","properties":{"body":"let siteName = steps.InputParams.params.input.siteName;\nlet siteDomain = steps.InputParams.params.input.siteDomain;\nlet apiKey = steps.InputParams.params.input.apiKey;\nlet integration_name = steps.InputParams.params.input.integration_name;\n\nlet existingTpConfig = steps.getTpConfig.response.body.third_party_configuration.config_json;\n\nlet newTpConfig = existingTpConfig;\nnewTpConfig.cloudElements.syncFields = steps.InputParams.params.configParams;\n\nnewTpConfig[\"new_sub_step\"] = \"step_3\";\n\nlet tpConfigUpdateParams = {\n  url: \"https://\"+siteName+\".integrations.\"+siteDomain+\"/integrations/update_tp_integ_conf\",\n  headers: {\n    \"Content-Type\": \"application/json\",\n    \"cache-control\": \"no-cache\"\n  },\n  body: {\n     site_name: siteName,\n     api_key: apiKey,\n     integration_name: integration_name,\n     config_json: newTpConfig\n  }\n}\n\n\ndone({\n  newTpConfig: newTpConfig,\n  tpConfigUpdateParams: tpConfigUpdateParams\n});"}},{"id":215747,"onSuccess":["Success"],"onFailure":[],"name":"updateTpConfig","type":"httpRequest","properties":{"method":"POST","url":"${steps.tpConfigPayload.tpConfigUpdateParams.url}","retryAttempts":"5","body":"${steps.tpConfigPayload.tpConfigUpdateParams.body}","headers":"${steps.tpConfigPayload.tpConfigUpdateParams.headers}","retryDelay":"200"}}],"triggers":[{"id":26036,"onSuccess":["InputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"method":"GET","uri":"/pipedrive/syncFieldsConfig","engine":"v1","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"api":"GET /pipedrive/syncFieldsConfig","configuration":[]}