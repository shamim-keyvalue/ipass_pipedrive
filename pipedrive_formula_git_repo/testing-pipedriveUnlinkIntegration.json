{"id":29418,"name":"testing-pipedriveUnlinkIntegration","userId":27893,"accountId":24428,"createdDate":"2019-09-05T07:07:36Z","steps":[{"id":216307,"onSuccess":["deleteThirdPartyInstance_params"],"onFailure":["updateTpConfig_params"],"name":"allFormulaInstancesDeleted","type":"filter","properties":{"body":"if(steps.updateErrorLog_2 !== undefined){\n  if(steps.updateErrorLog_2.errorLog.length === 0){\n    done(true);\n  }else{\n    done(false);  \n  }\n}\n\ndone(true);"}},{"id":216308,"onSuccess":["loopOverFormulaConfigurations"],"onFailure":[],"name":"ConfigParams","type":"script","properties":{"body":"let configJson = steps.getTpConfig.response.body.third_party_configuration.config_json;\n\nlet params = {};\n\n(configJson.cloudElements.syncRulesContacts !== undefined) ? delete configJson.cloudElements.syncRulesContacts : '';\n(configJson.cloudElements.syncRulesDeals !== undefined) ? delete configJson.cloudElements.syncRulesDeals : '';\n(configJson.cloudElements.syncFields.personFields !== undefined) ? delete configJson.cloudElements.syncFields.personFields : '';\n(configJson.cloudElements.syncFields.subscriptionFields !== undefined) ? delete configJson.cloudElements.syncFields.subscriptionFields : '';\n(configJson.cloudElements.formulas.formula_ValidateSetup.execution_data !== undefined) ? delete configJson.cloudElements.formulas.formula_ValidateSetup.execution_data : '';\n(configJson.cloudElements.formulas.formula_ValidateResult.execution_data !== undefined) ? delete configJson.cloudElements.formulas.formula_ValidateResult.execution_data : '';\n(configJson.cloudElements.formulas.formula_InitialSyncRun.lastSyncDetails !== undefined) ? delete configJson.cloudElements.formulas.formula_InitialSyncRun.lastSyncDetails : '';\n(configJson.cloudElements.formulas.formula_FullSyncRun.lastSyncDetails !== undefined) ? delete configJson.cloudElements.formulas.formula_FullSyncRun.lastSyncDetails : '';\n\nconfigJson.cloudElements.customFieldMap.customerFields = null;\nconfigJson.cloudElements.customFieldMap.dealFields = null;\nconfigJson.cloudElements.customFieldMap.organizationFields = null;\n\nparams.configJson = configJson;\n\nparams.deleteArray = [];\n\nparams.deleteArray.push(params.configJson.cloudElements.formulas.formula_ValidateResult);\nparams.deleteArray.push(params.configJson.cloudElements.formulas.formula_SyncDispatcher);\nparams.deleteArray.push(params.configJson.cloudElements.formulas.formula_SyncCustomers);\nparams.deleteArray.push(params.configJson.cloudElements.formulas.formula_SyncSubscription);\nparams.deleteArray.push(params.configJson.cloudElements.formulas.formula_SyncInvoice);\n\n\n\n\ndone({\n params: params \n});\n"}},{"id":216309,"onSuccess":["DeleteFormulaInstance"],"onFailure":[],"name":"deleteConfig","type":"script","properties":{"body":"let formulaId = steps.loopOverFormulaConfigurations.entry.id;\nlet instanceId = steps.loopOverFormulaConfigurations.entry.instance;\n\nlet params = {\n  formula: formulaId,\n  instance: instanceId\n}\n\ndone(params)"}},{"id":216310,"onSuccess":["isDeleteFormulaSuccess"],"onFailure":["isDeleteFormulaSuccess"],"name":"DeleteFormulaInstance","type":"request","properties":{"retryDelay":"200","api":"/formulas/${steps.deleteConfig.formula}/instances/${steps.deleteConfig.instance}","retryAttempts":"5","method":"DELETE"}},{"id":216311,"onSuccess":["isDeleteThirdPartyInstanceSuccess"],"onFailure":["isDeleteThirdPartyInstanceSuccess"],"name":"deleteThirdPartyElementInstance","type":"request","properties":{"retryDelay":"200","retry":"true","api":"${steps.deleteThirdPartyInstance_params.payload.url}","retryAttempts":"5","method":"DELETE"}},{"id":216312,"onSuccess":["deleteThirdPartyElementInstance"],"onFailure":[],"name":"deleteThirdPartyInstance_params","type":"script","properties":{"body":"let thirdpartyInstance_data = steps.getTpConfig.response.body.third_party_configuration.config_json.cloudElements.thirdParty;\n\nlet payload = {\n  url:  \"/instances/\"+thirdpartyInstance_data.instance\n};\n\n\ndone({\n  payload: payload,\n  instance: thirdpartyInstance_data\n});"}},{"id":216313,"onSuccess":[],"onFailure":[],"name":"FinalStep","type":"script","properties":{"body":"let errorLog1 = steps.updateErrorLog_1 ? steps.updateErrorLog_1.errorLog : [];\nlet errorLog2 = steps.updateErrorLog_2 ? steps.updateErrorLog_2.errorLog : [];\n\nlet FinalStepLog1 = steps.updateFinalStepLog_1 ? steps.updateFinalStepLog_1.FinalStepLog : [];\nlet FinalStepLog2 = steps.updateFinalStepLog_2 ? steps.updateFinalStepLog_2.FinalStepLog : [];\n\nlet errorLog = errorLog1.concat(errorLog2);\nlet FinalStepLog = FinalStepLog1.concat(FinalStepLog2);\n\n// if(errorLog.length > 0){\n//   done({\n//     statusCode: 500\n//   });\n// }\n\ndone({statusCode : 200});"}},{"id":216314,"onSuccess":["ConfigParams"],"onFailure":[],"name":"getTpConfig","type":"httpRequest","properties":{"query":"${steps.InputParams.getTpConfigParams.query}","retryDelay":"200","url":"${steps.InputParams.getTpConfigParams.url}","headers":"${steps.InputParams.getTpConfigParams.auth}","retry":"true","retryAttempts":"5","method":"GET"}},{"id":216315,"onSuccess":["deleteConfig"],"onFailure":["loopOverFormulaConfigurations"],"name":"hasFormulaID","type":"filter","properties":{"body":"if(steps.loopOverFormulaConfigurations.entry.id !== undefined){\n  done(true);\n}\ndone(false);"}},{"id":216316,"onSuccess":["retrieveLatestSyncDetails"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let apiKey = trigger.args.request.query['cb-api-key'];\nlet siteName = trigger.args.request.query['cb-site-name'];\nlet integrationName = 'pipedrive';\nlet siteDomain = trigger.args.request.query['cb-domain'];\nlet password = \"\";\n\n\nlet params = {\n  input: {\n    apiKey: apiKey,\n    siteName: siteName,\n    siteDomain:siteDomain,\n    integrationName: integrationName\n  }\n};\n\nlet getTpConfigParams = {\n  url: \"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_configurations\",\n  auth:{\n    Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password)\n  },\n  query:{\n    integration_name: integrationName\n  }\n};\n\nlet tpConfigUpdateParams = {\n  url: \"https://\"+siteName+\".integrations.\"+siteDomain+\"/integrations/update_tp_integ_conf\",\n  headers: {\n    \"Content-Type\": \"application/json\",\n    \"cache-control\": \"no-cache\"\n  },\n  body:  {\n     site_name: siteName,\n     api_key: apiKey,\n     integration_name: integrationName\n  }\n}\n\nlet getLastSyncDetails = {\n    url:\"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_sync_details/retrieve_latest_sync\",\n    auth:{\n      Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password)\n    },\n    query:{\n      'third_party_configuration[integration_name]': integrationName\n    }\n  };\n\n\ndone({\n  params: params,\n  getTpConfigParams: getTpConfigParams,\n  tpConfigUpdateParams: tpConfigUpdateParams,\n  getLastSyncDetails: getLastSyncDetails\n});"}},{"id":216317,"onSuccess":["updateSuccessLog_2"],"onFailure":["updateErrorLog_2"],"name":"isDeleteFormulaSuccess","type":"filter","properties":{"body":"if(steps.DeleteFormulaInstance.response.code !== 200){\n  done(false)\n}\n\ndone(true)"}},{"id":216318,"onSuccess":["updateSuccessLog_1"],"onFailure":["updateErrorLog_1"],"name":"isDeleteThirdPartyInstanceSuccess","type":"filter","properties":{"body":"if(steps.deleteThirdPartyElementInstance.response.code !== 200){\n  done(false);\n}\ndone(true);"}},{"id":228926,"onSuccess":["getTpConfig"],"onFailure":["messageSyncRunning"],"name":"isSyncRunning","type":"filter","properties":{"body":"if((steps.retrieveLatestSyncDetails.response.code !== 200) || (steps.retrieveLatestSyncDetails.response.body.third_party_sync_detail === undefined)){\n  done(false);\n}\n\nif((steps.retrieveLatestSyncDetails.response.body.third_party_sync_detail.status === \"running\") || (steps.retrieveLatestSyncDetails.response.body.third_party_sync_detail.status === \"started\")){\n  done(false);\n}\n\n\ndone(true);"}},{"id":216319,"onSuccess":["hasFormulaID"],"onFailure":["allFormulaInstancesDeleted"],"name":"loopOverFormulaConfigurations","type":"loop","properties":{"list":"${steps.ConfigParams.params.deleteArray}"}},{"id":228927,"onSuccess":[],"onFailure":[],"name":"messageSyncRunning","type":"script","properties":{"body":"let card = {\n \"notice\" : \"Cannot Unlink, sync in progress\"\n};\n\ndone({\n  statusCode: 200,\n  result: card\n});"}},{"id":228925,"onSuccess":["isSyncRunning"],"onFailure":[],"name":"retrieveLatestSyncDetails","type":"httpRequest","properties":{"query":"${steps.InputParams.getLastSyncDetails.query}","retryDelay":"200","url":"${steps.InputParams.getLastSyncDetails.url}","headers":"${steps.InputParams.getLastSyncDetails.auth}","retry":"true","method":"GET","retryAttempts":"5"}},{"id":216320,"onSuccess":[],"onFailure":[],"name":"test","type":"script","properties":{"body":"done(false);"}},{"id":216321,"onSuccess":[],"onFailure":[],"name":"testFalse","type":"filter","properties":{"body":"done(false);"}},{"id":216322,"onSuccess":["FinalStep"],"onFailure":[],"name":"updateConfigJSON","type":"httpRequest","properties":{"query":"${steps.updateParams.update}","retryDelay":"200","url":"${steps.InputParams.input.config.url}","headers":"${steps.InputParams.input.config.auth}","retryAttempts":"5","method":"POST"}},{"id":216323,"onSuccess":["FinalStep"],"onFailure":[],"name":"updateErrorLog_1","type":"script","properties":{"body":"let errorLog = [];\n\n\nif(steps.updateErrorLog_1 !== undefined){\n  errorLog = steps.updateErrorLog_1.errorLog;\n}\n\nerrorLog.push(\"Failed to Delete third party instance with ID: \"+ deleteThirdPartyInstance_params.instance + \"\\n\");\n\n\ndone({errorLog: errorLog});"}},{"id":216324,"onSuccess":["loopOverFormulaConfigurations"],"onFailure":[],"name":"updateErrorLog_2","type":"script","properties":{"body":"let errorLog = [];\n\nif(steps.updateErrorLog_2 !== undefined){\n  errorLog = steps.updateErrorLog_2.errorLog;\n}\n\nerrorLog.push(\"\\nFailed to Delete The Formula Instance\\n Formula ID: \"+ steps.deleteConfig.formula + \"\\nInstance ID: \" + steps.deleteConfig.instance + \"\\n\");\n\ndone({errorLog:errorLog});\n"}},{"id":216325,"onSuccess":["FinalStep"],"onFailure":[],"name":"updateParams","type":"script","properties":{"body":"let errorLog1 = steps.updateErrorLog_1 ? steps.updateErrorLog_1.errorLog : [];\nlet errorLog2 = steps.updateErrorLog_2 ? steps.updateErrorLog_2.errorLog : [];\n\nlet FinalStepLog1 = steps.updateFinalStepLog_1 ? steps.updateFinalStepLog_1.FinalStepLog : [];\nlet FinalStepLog2 = steps.updateFinalStepLog_2 ? steps.updateFinalStepLog_2.FinalStepLog : [];\n\nlet errorLog = errorLog1.concat(errorLog2);\nlet FinalStepLog = FinalStepLog1.concat(FinalStepLog2);\n\n\nlet configJson = {\n  cloudElements: {\n    FinalStep : FinalStepLog,\n    failed : errorLog,\n    chargebee : steps.ConfigParams.configJSON.cloudElements.chargebee\n  }\n}\n\nlet configParam = {\"new_sub_step\": \"\"};\n\n\nlet input = {\n  update: {\n    integration_name: trigger.args.request.query.type,\n    \"config_json\": \"{}\"\n  }\n};\n\n\ndone(input);"}},{"id":216326,"onSuccess":["FinalStep"],"onFailure":[],"name":"updateSuccessLog_1","type":"script","properties":{"body":"let successLog = [];\n\n\nif(steps.updateFinalStepLog_1 !== undefined){\n  successLog = steps.updateFinalStepLog_1.successLog;\n}\n\nsuccessLog.push(\"Successfully deleted the third party instance with ID: \"+ steps.ConfigParams.params.configJson.cloudElements.thirdParty.instance + \"\\n\")\n\n\ndone({successLog: successLog});"}},{"id":216327,"onSuccess":["loopOverFormulaConfigurations"],"onFailure":[],"name":"updateSuccessLog_2","type":"script","properties":{"body":"let FinalStepLog = [];\n\nif(steps.updateFinalStepLog_2 !== undefined){\n  FinalStepLog = steps.updateFinalStepLog_2.FinalStepLog;\n}\n\nFinalStepLog.push(\"\\nSuccessfully deleted the Formula Instance\\n Formula ID: \"+ steps.deleteConfig.formula + \"\\nInstance ID: \" + steps.deleteConfig.instance + \"\\n\");\n\ndone({FinalStepLog:FinalStepLog});\n"}},{"id":216328,"onSuccess":["FinalStep"],"onFailure":[],"name":"updateTpConfig","type":"httpRequest","properties":{"retryDelay":"200","body":"${steps.updateTpConfig_params.payload.body}","url":"${steps.updateTpConfig_params.payload.url}","headers":"${steps.updateTpConfig_params.payload.headers}","retry":"true","retryAttempts":"5","method":"POST"}},{"id":216329,"onSuccess":["updateTpConfig"],"onFailure":[],"name":"updateTpConfig_params","type":"script","properties":{"body":"let updateParams = steps.InputParams.tpConfigUpdateParams;\n\nupdateParams.body.config_json = \"{}\";\n\ndone({\n  payload: updateParams\n});"}}],"triggers":[{"id":26046,"onSuccess":["InputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"method":"GET","uri":"/pipedrive/unlink","engine":"v1","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"api":"GET /pipedrive/unlink","configuration":[]}